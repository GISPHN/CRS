<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>CRS比較デモ（正誤解釈の比較・OSMタイル版）</title>
  <!-- MapLibre GL のCSS -->
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-wrap: wrap;
      font-family: sans-serif;
      background: #f5f5f5;
    }
    /* 各マップの配置 */
    .map-container {
      position: relative;
      width: 32%;
      height: 400px;
      margin: 1%;
      border: 1px solid #ccc;
      box-sizing: border-box;
      background: #fff;
    }
    .map-label {
      position: absolute;
      top: 5px;
      left: 5px;
      background: rgba(255,255,255,0.9);
      padding: 2px 5px;
      z-index: 2;
      font-weight: bold;
      font-size: 14px;
    }
    .legend {
      position: absolute;
      top: 30px;
      left: 5px;
      background: rgba(255,255,255,0.9);
      padding: 2px 5px;
      z-index: 2;
      font-size: 12px;
    }
    .coordinate-display {
      position: absolute;
      bottom: 5px;
      left: 5px;
      background: rgba(255,255,255,0.9);
      padding: 2px 5px;
      z-index: 2;
      font-size: 12px;
    }
    .toggle-btn {
      position: absolute;
      top: 60px;
      left: 5px;
      z-index: 2;
      font-size: 12px;
      padding: 2px 5px;
    }
  </style>
</head>
<body>
  <!-- 各CRSごとのマップコンテナ -->
  <div id="map6674" class="map-container">
    <div class="map-label">EPSG:6674</div>
    <div class="legend">青: 正しい解釈<br>赤: 誤った解釈</div>
    <button class="toggle-btn" id="toggle6674">切替</button>
    <div class="coordinate-display" id="coord6674"></div>
  </div>
  <div id="map6668" class="map-container">
    <div class="map-label">EPSG:6668</div>
    <div class="legend">青: 正しい解釈<br>赤: 誤った解釈</div>
    <button class="toggle-btn" id="toggle6668">切替</button>
    <div class="coordinate-display" id="coord6668"></div>
  </div>
  <div id="map6690" class="map-container">
    <div class="map-label">EPSG:6690</div>
    <div class="legend">青: 正しい解釈<br>赤: 誤った解釈</div>
    <button class="toggle-btn" id="toggle6690">切替</button>
    <div class="coordinate-display" id="coord6690"></div>
  </div>
  <div id="map4326" class="map-container">
    <div class="map-label">EPSG:4326</div>
    <div class="legend">青: 正しい解釈<br>赤: 誤った解釈<br>(EPSG:4326は同一)</div>
    <button class="toggle-btn" id="toggle4326">切替</button>
    <div class="coordinate-display" id="coord4326"></div>
  </div>
  <div id="map3857" class="map-container">
    <div class="map-label">EPSG:3857</div>
    <div class="legend">青: 正しい解釈<br>赤: 誤った解釈</div>
    <button class="toggle-btn" id="toggle3857">切替</button>
    <div class="coordinate-display" id="coord3857"></div>
  </div>

  <!-- MapLibre GL JS -->
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <!-- Proj4js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
  <!-- maplibre-gl-proj プラグイン -->
  <script src="https://unpkg.com/maplibre-gl-proj@latest/dist/maplibre-gl-proj.js"></script>

  <script>
    /* ■ OSMタイルを利用するためのスタイルJSONを定義 */
    const osmStyle = {
      "version": 8,
      "name": "OSM",
      "sources": {
        "osm": {
          "type": "raster",
          "tiles": [
            "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png",
            "https://b.tile.openstreetmap.org/{z}/{x}/{y}.png",
            "https://c.tile.openstreetmap.org/{z}/{x}/{y}.png"
          ],
          "tileSize": 256,
          "attribution": "© OpenStreetMap contributors"
        }
      },
      "layers": [
        {
          "id": "osm",
          "type": "raster",
          "source": "osm",
          "minzoom": 0,
          "maxzoom": 19
        }
      ]
    };

    // 大阪中心の座標（EPSG:4326）
    const centerOsaka = [135.5023, 34.6937];

    /* --- Proj4の定義 --- */
    // EPSG:4326, EPSG:3857は既知の定義なので定義不要

    // EPSG:6674 – JGD2000 / Japan Plane Rectangular CS XI  
    // 公式例: 中央緯度 36°, 中央経線 139°50′00″ (139.8333333°), scale factor 0.9999  
    proj4.defs("EPSG:6674", "+proj=tmerc +lat_0=36 +lon_0=139.8333333333333 +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs");

    // EPSG:6668 – JGD2000 / Japan Plane Rectangular CS VII  
    // 公式例: 中央緯度 36°, 中央経線 137°10′00″ (137.1666667°), scale factor 0.9999  
    proj4.defs("EPSG:6668", "+proj=tmerc +lat_0=36 +lon_0=137.1666666666667 +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs");

    // EPSG:6690 – JGD2000 / Japan Plane Rectangular CS XIII  
    // 公式例: 中央緯度 36°, 中央経線 141°10′00″ (141.1666667°), scale factor 0.9999  
    proj4.defs("EPSG:6690", "+proj=tmerc +lat_0=36 +lon_0=141.1666666666667 +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs");

    /* --- MapLibre用のカスタム投影設定 --- */
    function getProjectionConfig(crsCode) {
      if (crsCode === 'EPSG:6674' ||
          crsCode === 'EPSG:6668' ||
          crsCode === 'EPSG:6690' ||
          crsCode === 'EPSG:4326') {
        return {
          name: 'custom',
          customProj: crsCode
        };
      } else if (crsCode === 'EPSG:3857') {
        return {
          name: 'mercator'
        };
      }
    }

    // マーカー管理用オブジェクト
    const maps = {};
    const markers = {}; // { crsCode: { correct: Marker, wrong: Marker, showWrong: boolean } }

    // マップ生成用共通関数
    function createMap(containerId, crsCode) {
      const map = new maplibregl.Map({
        container: containerId,
        style: osmStyle,  // OSMタイルを利用するスタイル
        center: centerOsaka, // 入力はEPSG:4326
        zoom: 10,
        projection: getProjectionConfig(crsCode)
      });

      // 青いマーカー（正しい解釈）: 入力座標 centerOsaka をそのまま渡す
      const correctMarker = new maplibregl.Marker({ color: 'blue' })
                              .setLngLat(centerOsaka)
                              .addTo(map);

      // 赤いマーカー（誤った解釈）:
      // → 入力値 centerOsaka を一度対象CRSへ変換し、その結果を「地理座標」として渡す
      const wrongCoord = proj4('EPSG:4326', crsCode, centerOsaka);
      const wrongMarker = new maplibregl.Marker({ color: 'red' })
                            .setLngLat(wrongCoord)
                            .addTo(map);
      // 初期状態は正しい解釈のみ表示
      wrongMarker.getElement().style.display = 'none';

      markers[crsCode] = {
        correct: correctMarker,
        wrong: wrongMarker,
        showWrong: false
      };

      // クリック時にその地点の座標を表示（そのマップの投影に沿った値）
      map.on('click', function(e) {
        const lng = e.lngLat.lng.toFixed(5);
        const lat = e.lngLat.lat.toFixed(5);
        const coordText = `座標: ${lng}, ${lat}`;
        document.getElementById("coord" + crsCode.slice(5)).innerHTML = coordText;
      });

      return map;
    }

    // 各CRSごとにマップ生成
    maps['EPSG:6674'] = createMap('map6674', 'EPSG:6674');
    maps['EPSG:6668'] = createMap('map6668', 'EPSG:6668');
    maps['EPSG:6690'] = createMap('map6690', 'EPSG:6690');
    maps['EPSG:4326'] = createMap('map4326', 'EPSG:4326');
    maps['EPSG:3857'] = createMap('map3857', 'EPSG:3857');

    // 切替ボタンによるマーカー表示のトグル
    function toggleMarker(crsCode) {
      const markerObj = markers[crsCode];
      markerObj.showWrong = !markerObj.showWrong;
      if (markerObj.showWrong) {
        markerObj.wrong.getElement().style.display = 'block';
        markerObj.correct.getElement().style.display = 'none';
      } else {
        markerObj.wrong.getElement().style.display = 'none';
        markerObj.correct.getElement().style.display = 'block';
      }
    }
    document.getElementById('toggle6674').addEventListener('click', () => toggleMarker('EPSG:6674'));
    document.getElementById('toggle6668').addEventListener('click', () => toggleMarker('EPSG:6668'));
    document.getElementById('toggle6690').addEventListener('click', () => toggleMarker('EPSG:6690'));
    document.getElementById('toggle4326').addEventListener('click', () => toggleMarker('EPSG:4326'));
    document.getElementById('toggle3857').addEventListener('click', () => toggleMarker('EPSG:3857'));

    // ※オプション: マップ間の中心・ズームの同期（ここではEPSG:3857をマスター）
    function syncMaps(masterMap, mapsToSync) {
      masterMap.on('move', () => {
        const center = masterMap.getCenter();
        const zoom = masterMap.getZoom();
        mapsToSync.forEach(map => {
          map.setCenter(center);
          map.setZoom(zoom);
        });
      });
    }
    syncMaps(maps['EPSG:3857'], [maps['EPSG:6674'], maps['EPSG:6668'], maps['EPSG:6690'], maps['EPSG:4326']]);
  </script>
</body>
</html>
