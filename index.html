<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>CRS比較デモ – 正しい変換 vs 誤った変換</title>
  <!-- MapLibre GL CSS -->
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    /* コントロールパネル（右上） */
    .control-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      font-family: sans-serif;
      z-index: 10;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .control-panel button {
      display: block;
      margin-bottom: 5px;
      width: 100%;
    }
    .info {
      margin-top: 5px;
      font-size: 12px;
      line-height: 1.3;
    }
    /* マーカーラベル用（透過背景） */
    .marker-label {
      background: rgba(255,255,255,0.8);
      padding: 2px 4px;
      border: 1px solid #333;
      border-radius: 3px;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <!-- コントロールパネル -->
  <div class="control-panel">
    <strong>CRS マーカー表示</strong>
    <button id="btn-6674">EPSG:6674 を表示</button>
    <button id="btn-6668">EPSG:6668 を表示</button>
    <button id="btn-6690">EPSG:6690 を表示</button>
    <button id="btn-4326">EPSG:4326 を表示</button>
    <button id="btn-3857">EPSG:3857 を表示</button>
    <div class="info" id="infoArea">
      <!-- クリック時の座標等を表示 -->
    </div>
  </div>

  <!-- MapLibre GL JS -->
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <!-- Proj4js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
  <script>
    /**********************************************************************
     * 内部方針（思考過程の概要）
     * 
     * 1. 基本地図は EPSG:3857 の OSM タイルで表示します。
     * 2. 大阪中心の座標（EPSG:4326: [135.5023, 34.6937]）を基準とします。
     * 3. 各 CRS ごとに、正しい変換の場合：
     *      ・まず、EPSG:4326 → 対象CRS へ変換（proj4）。
     *      ・その結果を、対象CRS → EPSG:3857 へ変換して表示。
     *    誤った変換の場合：
     *      ・入力値（EPSG:4326の値）を「すでに対象CRSの座標」として対象CRS → EPSG:3857 へ変換。
     * 4. これにより、CRS による内部の数値の違いが、最終的に表示位置のズレとして現れる様子を視覚的に確認できます。
     **********************************************************************/

    // 地図の初期設定：EPSG:3857 用
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        "version": 8,
        "sources": {
          "osm": {
            "type": "raster",
            "tiles": [
              "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png",
              "https://b.tile.openstreetmap.org/{z}/{x}/{y}.png",
              "https://c.tile.openstreetmap.org/{z}/{x}/{y}.png"
            ],
            "tileSize": 256,
            "attribution": "© OpenStreetMap contributors"
          }
        },
        "layers": [
          {
            "id": "osm",
            "type": "raster",
            "source": "osm",
            "minzoom": 0,
            "maxzoom": 19
          }
        ]
      },
      center: [135.5023, 34.6937], // ※内部は EPSG:3857、ただし MapLibre は中心値の指定は緯度経度とする
      zoom: 10
    });

    // 基本となる中心座標（EPSG:4326、[lon, lat]）
    const centerOsaka = [135.5023, 34.6937];

    // Proj4 の定義（EPSG:4326, EPSG:3857 は既知）
    // 以下、EPSG:6674, 6668, 6690 の定義は公式例（実際は各機関の最新情報をご参照ください）
    proj4.defs("EPSG:6674", "+proj=tmerc +lat_0=36 +lon_0=139.8333333333333 +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs");
    proj4.defs("EPSG:6668", "+proj=tmerc +lat_0=36 +lon_0=137.1666666666667 +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs");
    proj4.defs("EPSG:6690", "+proj=tmerc +lat_0=36 +lon_0=141.1666666666667 +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs");
    // EPSG:4326 と EPSG:3857 は proj4 内部で既に定義済み

    // 各対象CRSのリスト
    const crsList = ["EPSG:6674", "EPSG:6668", "EPSG:6690", "EPSG:4326", "EPSG:3857"];

    // マーカー群を格納するオブジェクト（各CRSごとに保存）
    const crsMarkers = {}; // { "EPSG:xxxx": { correct: marker, wrong: marker } }

    // 既に表示中の CRS（重ねて表示しないよう切替）
    let currentCRS = null;

    // 画面にマーカーを追加する関数
    // 表示のためには、最終的にEPSG:3857に変換した座標を用います
    function addCRSMarkers(crsCode) {
      // 正しい変換の場合：
      //   1. centerOsaka（EPSG:4326） → 対象CRS へ変換（正しい値）
      //   2. その結果を対象CRS → EPSG:3857 へ変換して表示
      const correctTemp = proj4("EPSG:4326", crsCode, centerOsaka);
      const correctCoord = proj4(crsCode, "EPSG:3857", correctTemp);

      // 誤った変換の場合：
      //   入力値 centerOsaka（EPSG:4326の数値）を「すでに対象CRSの座標」と見なして、
      //   対象CRS → EPSG:3857 へ変換
      const wrongCoord = proj4(crsCode, "EPSG:3857", centerOsaka);

      // マーカーを作成（blue: 正しい, red: 誤った）
      const correctMarker = new maplibregl.Marker({ color: "blue" })
                                .setLngLat(correctCoord)
                                .addTo(map);
      const wrongMarker = new maplibregl.Marker({ color: "red" })
                                .setLngLat(wrongCoord)
                                .addTo(map);

      // それぞれにラベルを付加して、数値も表示
      addMarkerLabel(correctMarker, "正しい\n" + formatCoord(correctCoord));
      addMarkerLabel(wrongMarker, "誤った\n" + formatCoord(wrongCoord));

      // 保存
      crsMarkers[crsCode] = { correct: correctMarker, wrong: wrongMarker };
    }

    // マーカーにラベルを付加する関数（マーカーの DOM 要素に重ねる）
    function addMarkerLabel(marker, text) {
      const el = marker.getElement();
      // 既にラベルがあれば削除
      let label = el.querySelector(".marker-label");
      if (!label) {
        label = document.createElement("div");
        label.className = "marker-label";
        el.appendChild(label);
      }
      label.innerText = text;
    }

    // 座標の数値をフォーマットする関数（EPSG:3857の場合、値が大きくなるので小数点以下3桁）
    function formatCoord(coord) {
      return "X:" + coord[0].toFixed(3) + "\nY:" + coord[1].toFixed(3);
    }

    // すべての CRS マーカーを非表示にする
    function hideAllMarkers() {
      for (const key in crsMarkers) {
        if (crsMarkers.hasOwnProperty(key)) {
          crsMarkers[key].correct.remove();
          crsMarkers[key].wrong.remove();
        }
      }
      crsMarkers = {}; // ※※ ※ここでは再作成するため、既存のオブジェクトをクリア（ただし const を使っていた場合は注意）
    }

    // 表示状態を切り替えるため、すでに表示中のマーカーがあれば削除し、選択した CRS のマーカーを追加
    function showCRS(crsCode) {
      // 既に表示中の場合はクリア
      for (const key in crsMarkers) {
        if (crsMarkers.hasOwnProperty(key)) {
          crsMarkers[key].correct.remove();
          crsMarkers[key].wrong.remove();
        }
      }
      // マーカー群オブジェクトを初期化（再利用しない）
      for (const crs of crsList) {
        delete crsMarkers[crs];
      }
      // 新たに対象CRSのマーカーを作成
      addCRSMarkers(crsCode);
      currentCRS = crsCode;
      // 情報エリアに変換結果を表示
      document.getElementById("infoArea").innerText =
        "【" + crsCode + "】\n" +
        "正しい変換:\n" + formatCoord( proj4(crsCode, "EPSG:3857", proj4("EPSG:4326", crsCode, centerOsaka)) ) +
        "\n\n誤った変換:\n" + formatCoord( proj4(crsCode, "EPSG:3857", centerOsaka) );
    }

    // 初期は何も表示していない状態にする
    // 各ボタンにクリックイベントを登録
    document.getElementById("btn-6674").addEventListener("click", function() {
      showCRS("EPSG:6674");
    });
    document.getElementById("btn-6668").addEventListener("click", function() {
      showCRS("EPSG:6668");
    });
    document.getElementById("btn-6690").addEventListener("click", function() {
      showCRS("EPSG:6690");
    });
    document.getElementById("btn-4326").addEventListener("click", function() {
      showCRS("EPSG:4326");
    });
    document.getElementById("btn-3857").addEventListener("click", function() {
      showCRS("EPSG:3857");
    });

    // ※ 初回は EPSG:3857 を表示（OSMタイルのため見やすい）
    showCRS("EPSG:3857");
  </script>
</body>
</html>
